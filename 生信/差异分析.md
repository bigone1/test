### DESeq2

```R
load("gdc.Rdata")
library(DESeq2)
colData <- data.frame(row.names =colnames(expr), 
                      condition=group_list)
dds <- DESeqDataSetFromMatrix(
  countData = expr,
  colData = colData,
  design = ~ condition)
dds <- DESeq(dds)
res <- results(dds, contrast = c("condition",rev(levels(group_list))))
resOrdered <- res[order(res$pvalue),]
DEG_DESeq2 <- as.data.frame(resOrdered)
DEG_DESeq2 <- na.omit(DEG_DESeq2)
#计算logFC阈值
logFC_cutoff <- with(DEG_DESeq2,mean(abs(log2FoldChange)) + 
                       2*sd(abs(log2FoldChange)))
#直接设置logFC阈值
logFC_cutoff <- 2
DEG_DESeq2$change = as.factor(
  ifelse(DEG_DESeq2$padj < 0.05 & abs(DEG_DESeq2$log2FoldChange) > logFC_cutoff,
         ifelse(DEG_DESeq2$log2FoldChange > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_DESeq2 <- subset(DEG_DESeq2,padj<0.05 & abs(log2FoldChange)>2)
```

### edgeR

```R
library(edgeR)

dge <- DGEList(counts=expr,group=group_list)
dge$samples$lib.size <- colSums(dge$counts)
dge <- calcNormFactors(dge) 

design <- model.matrix(~0+group_list)
rownames(design)<-colnames(dge)
colnames(design)<-levels(group_list)

dge <- estimateGLMCommonDisp(dge,design)
dge <- estimateGLMTrendedDisp(dge, design)
dge <- estimateGLMTagwiseDisp(dge, design)

fit <- glmFit(dge, design)
fit2 <- glmLRT(fit, contrast=c(-1,1)) 

DEG_edgeR <- topTags(fit2, n=nrow(expr))
DEG_edgeR=as.data.frame(DEG_edgeR)
logFC_cutoff <- with(DEG_edgeR,mean(abs(logFC)) + 2*sd(abs(logFC)) )
#logFC_cutoff <- 2
DEG_edgeR$change = as.factor(
  ifelse(DEG_edgeR$FDR < 0.05 & abs(DEG_edgeR$logFC) > logFC_cutoff,
         ifelse(DEG_edgeR$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_edgeR <- subset(DEG_edgeR,FDR<0.05 & abs(logFC)>2)
```

### limma---1

```R
library(limma)

design <- model.matrix(~0+group_list)
colnames(design)=levels(group_list)
rownames(design)=colnames(expr)

dge <- DGEList(counts=expr)
dge <- calcNormFactors(dge)
logCPM <- cpm(dge, log=TRUE, prior.count=3)

v <- voom(dge,design, normalize="quantile")
fit <- lmFit(v, design)

constrasts = paste(rev(levels(group_list)),collapse = "-")
cont.matrix <- makeContrasts(contrasts=constrasts,levels = design) 
fit2=contrasts.fit(fit,cont.matrix)
fit2=eBayes(fit2)

DEG_limma = topTable(fit2, coef=constrasts, n=Inf)
DEG_limma = na.omit(DEG_limma)
#logFC_cutoff <- with(DEG_limma,mean(abs(logFC)) + 2*sd(abs(logFC)) )
logFC_cutoff <- 2
DEG_limma$change = as.factor(
  ifelse(DEG_limma$adj.P.Val < 0.05 & abs(DEG_limma$logFC) > logFC_cutoff,
         ifelse(DEG_limma$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_limma <- subset(DEG_limma,adj.P.Val<0.05 & abs(logFC)>2)
```

### limma---2

```R
library(limma)
expr.df <- read.table(file = "GSE42872_series_matrix.txt.gz", header =TRUE,
                      comment.char = "!")
library(hugene10sttranscriptcluster.db)
k <- as.character(expr.df$ID_REF)
out <- select(hugene10sttranscriptcluster.db,keys=k,
              columns=c('SYMBOL','GENENAME'),keytype='PROBEID')
out <- na.omit(out)
expr.df$symbol <- out[match(expr.df$ID_REF,out$PROBEID),2]
expr.df <- na.omit(expr.df)
expr.df <- dplyr::filter(expr.df,!duplicated(expr.df$symbol))
rownames(expr.df) <- expr.df$symbol
expr.df <- expr.df[,-ncol(expr.df)]
expr.df <- expr.df[,-1]
group <- c(rep("con",3),rep("treat",3))
group <- factor(group,levels = c("con","treat"),ordered = F)
design <- model.matrix(~group)
colnames(design) <- levels(group)
fit <- lmFit(expr.df,design)
fit2 <- eBayes(fit)
allDiff=topTable(fit2,adjust='fdr',coef=2,number=Inf)
diffLab <- subset(allDiff,abs(logFC) >1 & adj.P.Val < 0.05)
```

### GDCRNATools--R包：an R/Bioconductor package for downloading, organizing, and integrative analyzing lncRNA, mRNA, and miRNA data in GDC

https://github.com/Jialab-UCR/GDCRNATools

```R
library(GDCRNATools)
#mRNA的表达矩阵
data(rnaCounts)
#临床信息
metaMatrix.RNA <- gdcParseMetadata(project.id = 'TCGA-CHOL',
                                   data.type  = 'RNAseq',
                                   write.meta = FALSE)
metaMatrix.RNA <- gdcFilterDuplicate(metaMatrix.RNA)
metaMatrix.RNA <- gdcFilterSampleType(metaMatrix.RNA)
#过滤
rnaExpr <- gdcVoomNormalization(counts = rnaCounts, filter = FALSE)
#差异分析
DEGAll <- gdcDEAnalysis(counts     = rnaCounts, 
                        group      = metaMatrix.RNA$sample_type, 
                        comparison = 'PrimaryTumor-SolidTissueNormal', 
                        method     = 'limma')
dePC <- gdcDEReport(deg = DEGAll, gene.type = 'protein_coding')
#两个基因的相关性图
gdcCorPlot(gene1    = 'ENSG00000003989', 
           gene2    = 'ENSG00000004799', 
           rna.expr = rnaExpr, 
           metadata = metaMatrix.RNA)
#生存分析：两种方法---coxph、KM
survOutput1 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'coxph', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA)
survOutput2 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'KM', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA, 
                                  sep      = 'median')
gdcKMPlot(gene     = 'ENSG00000003989',
          rna.expr = rnaExpr,
          metadata = metaMatrix.RNA,
          sep      = 'median')
```

<<<<<<< HEAD
```R
library(data.table)
esca_expr <- fread('fanai/TCGA-ESCA.htseq_counts.tsv')
=======
### 消化道肿瘤ESTIMATE差异分析

```R
#COAD
library(data.table)
coad_expr <- fread('fanai/COAD/TCGA-COAD.htseq_counts.tsv')
#coad_surv <- fread('fanai/COAD/TCGA-COAD.survival.tsv')
coad_surv_d <- fread('fanai/COAD/COAD_survival.txt')
library(tibble)
coad_expr <- column_to_rownames(coad_expr,'Ensembl_ID')
coad_expr_lie <- colnames(coad_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(coad_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=coad_expr_lie,group=group_list)
tumor <- coad_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/COAD/coad_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','coad_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/COAD/coad_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_coad = res[order(res$pvalue),]
#write.csv(res_coad,file="chayi_gene_coad.csv")
diff_coad <- subset(res_coad,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_coad,file="fanai/COAD/chayi_coad2.csv")


#ESCA
library(data.table)
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
library(tibble)
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
esca_expr_lie <- colnames(esca_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(esca_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=esca_expr_lie,group=group_list)
tumor <- esca_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
<<<<<<< HEAD
write.table(tumor,file='fanai/esca_tumor.txt',sep='\t')
=======
write.table(tumor,file='fanai/ESCA/esca_tumor.txt',sep='\t')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','esca_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/ESCA/esca_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
<<<<<<< HEAD
res = results(dds, contrast=c("condition", "high", "low"),alpha = 0.05)
res_esca = res[order(res$padj),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
DESeq_norm_for_survial <- expr_norm[diff_esca@rownames,]
clinical <- fread('fanai/TCGA-ESCA.survival.tsv')
survival_cancer <- clinical
data <- t(DESeq_norm_for_survial)
survival_cancer <- column_to_rownames(survival_cancer,'sample')
jiaoji <- intersect(rownames(data),rownames(survival_cancer))
data <- data[jiaoji,]
survival_cancer <- survival_cancer[jiaoji,]
survival_cancer <- cbind(survival_cancer,data)
colnames(survival_cancer) <- gsub(colnames(survival_cancer),pattern = '-',replacement = '_')
uni_cox_bulk <- function(gene_list,survival_info_df){
  library(survival)
  gene_list <- gsub(gene_list,pattern = '-',replacement = '_')
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(OS.time,OS)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_cancer))
    ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    if(surv_uni_cox$coefficients[,5] < 0.05 & ph_hypothesis_p > 0.05){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
uni_cox_df <- uni_cox_bulk(gene_list = diff_esca@rownames,survival_info_df = survival_cancer)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca2.csv")
=======
res = results(dds, contrast=c("condition", "high", "low"))
res_esca = res[order(res$pvalue),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca2.csv")


#READ
library(data.table)
read_expr <- fread('fanai/READ/TCGA-READ.htseq_counts.tsv')
library(tibble)
read_expr <- column_to_rownames(read_expr,'Ensembl_ID')
read_expr_lie <- colnames(read_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(read_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=read_expr_lie,group=group_list)
tumor <- read_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/READ/read_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','read_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/READ/read_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_read = res[order(res$pvalue),]
diff_read <- subset(res_read,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_read,file="fanai/READ/chayi_read2.csv")

#STAD
library(data.table)
stad_expr <- fread('fanai/STAD/TCGA-STAD.htseq_counts.tsv')
library(tibble)
stad_expr <- column_to_rownames(stad_expr,'Ensembl_ID')
stad_expr_lie <- colnames(stad_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(stad_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=stad_expr_lie,group=group_list)
tumor <- stad_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/STAD/stad_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','stad_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/STAD/stad_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_stad = res[order(res$pvalue),]
diff_stad <- subset(res_stad,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_stad,file="fanai/STAD/chayi_stad2.csv")


#共同差异基因
coad <- read.csv('fanai/COAD/chayi_coad2.csv',row.names = 1)
esca <- read.csv('fanai/ESCA/chayi_esca2.csv',row.names = 1)
read <- read.csv('fanai/READ/chayi_read2.csv',row.names = 1)
stad <- read.csv('fanai/STAD/chayi_stad2.csv',row.names = 1)
#上调共差异
coad_s <- rownames(coad[coad$log2FoldChange>1.5,])
esca_s <- rownames(esca[esca$log2FoldChange>1.5,])
read_s <- rownames(read[read$log2FoldChange>1.5,])
stad_s <- rownames(stad[stad$log2FoldChange>1.5,])
a <- intersect(coad_s,esca_s)
b <- intersect(read_s,stad_s)
c <- intersect(a,b)
#下调共差异
coad_x <- rownames(coad[coad$log2FoldChange < -1.5,])
esca_x <- rownames(esca[esca$log2FoldChange < -1.5,])
read_x <- rownames(read[read$log2FoldChange < -1.5,])
stad_x <- rownames(stad[stad$log2FoldChange < -1.5,])
d <- intersect(coad_x,esca_x)
e <- intersect(read_x,stad_x)
f <- intersect(d,e)

#筛选免疫基因
mianyijiyin <- fread('免疫基因.txt')
mianyijiyin <- mianyijiyin$Symbol
shaixuan <- intersect(mianyijiyin,c)
write.csv(shaixuan,file='fanai/shaixuandemianyi.csv')


#火山图
load('fanai/ESCA/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_esca <- as.data.frame(res_esca)
library(ggplot2)
ggplot(data=res_esca, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_esca,abs(res_esca$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_esca,res_esca$padj < 0.05 & res_esca$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_esca,res_esca$padj < 0.05 & res_esca$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/COAD/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_coad <- as.data.frame(res_coad)
library(ggplot2)
ggplot(data=res_coad, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_coad,abs(res_coad$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_coad,res_coad$padj < 0.05 & res_coad$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_coad,res_coad$padj < 0.05 & res_coad$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/READ/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_read <- as.data.frame(res_read)
library(ggplot2)
ggplot(data=res_read, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_read,abs(res_read$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_read,res_read$padj < 0.05 & res_read$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_read,res_read$padj < 0.05 & res_read$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/STAD/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_stad <- as.data.frame(res_stad)
library(ggplot2)
ggplot(data=res_stad, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_stad,abs(res_stad$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_stad,res_stad$padj < 0.05 & res_stad$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_stad,res_stad$padj < 0.05 & res_stad$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

#提取免疫基因在四种癌症中的表达量
esca_immune_expr <- tumor[shaixuan,]
save(esca_immune_expr,file='fanai/escaie.Rdata')
load('fanai/COAD/shuju.RData')
load('fanai/gongtongchayi.RData')
coad_immune_expr <- tumor[shaixuan,]
save(coad_immune_expr,file='fanai/coadie.Rdata')
load('fanai/READ/shuju.RData')
read_immune_expr <- tumor[shaixuan,]
save(read_immune_expr,file='fanai/readie.Rdata')
load('fanai/STAD/shuju.RData')
stad_immune_expr <- tumor[shaixuan,]
save(stad_immune_expr,file='fanai/stadie.Rdata')

#合并免疫表达数据和OS临床数据
load('fanai/coadie.Rdata')
load('fanai/escaie.Rdata')
load('fanai/readie.Rdata')
load('fanai/stadie.Rdata')
library(data.table)
library(dplyr)
esca_immune_expr <- t(esca_immune_expr)
esca_surv_d <- fread('fanai/ESCA/ESCA_survival.txt')
esca_surv_d$sample <- paste(esca_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(esca_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,esca_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
esca_immune_expr <- esca_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(esca_immune_expr),rownames(sampleid_pipei))
esca_immune_expr_clin <- cbind(sampleid_pipei,esca_immune_expr)
save(esca_immune_expr_clin,file='fanai/esca-immune-expr-clin.Rdata')

stad_immune_expr <- t(stad_immune_expr)
stad_surv_d <- fread('fanai/STAD/STAD_survival.txt')
stad_surv_d$sample <- paste(stad_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(stad_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,stad_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
stad_immune_expr <- stad_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(stad_immune_expr),rownames(sampleid_pipei))
stad_immune_expr_clin <- cbind(sampleid_pipei,stad_immune_expr)
save(stad_immune_expr_clin,file='fanai/stad-immune-expr-clin.Rdata')

read_immune_expr <- t(read_immune_expr)
read_surv_d <- fread('fanai/READ/READ_survival.txt')
read_surv_d$sample <- paste(read_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(read_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,read_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
read_immune_expr <- read_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(read_immune_expr),rownames(sampleid_pipei))
read_immune_expr_clin <- cbind(sampleid_pipei,read_immune_expr)
save(read_immune_expr_clin,file='fanai/read-immune-expr-clin.Rdata')

coad_immune_expr <- t(coad_immune_expr)
coad_surv_d <- fread('fanai/COAD/COAD_survival.txt')
coad_surv_d$sample <- paste(coad_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(coad_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,coad_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
coad_immune_expr <- coad_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(coad_immune_expr),rownames(sampleid_pipei))
coad_immune_expr_clin <- cbind(sampleid_pipei,coad_immune_expr)
save(coad_immune_expr_clin,file='fanai/coad-immune-expr-clin.Rdata')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
```

