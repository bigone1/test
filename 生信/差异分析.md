### DESeq2

```R
load("gdc.Rdata")
library(DESeq2)
colData <- data.frame(row.names =colnames(expr), 
                      condition=group_list)
dds <- DESeqDataSetFromMatrix(
  countData = expr,
  colData = colData,
  design = ~ condition)
dds <- DESeq(dds)
res <- results(dds, contrast = c("condition",rev(levels(group_list))))
resOrdered <- res[order(res$pvalue),]
DEG_DESeq2 <- as.data.frame(resOrdered)
DEG_DESeq2 <- na.omit(DEG_DESeq2)
#计算logFC阈值
logFC_cutoff <- with(DEG_DESeq2,mean(abs(log2FoldChange)) + 
                       2*sd(abs(log2FoldChange)))
#直接设置logFC阈值
logFC_cutoff <- 2
DEG_DESeq2$change = as.factor(
  ifelse(DEG_DESeq2$padj < 0.05 & abs(DEG_DESeq2$log2FoldChange) > logFC_cutoff,
         ifelse(DEG_DESeq2$log2FoldChange > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_DESeq2 <- subset(DEG_DESeq2,padj<0.05 & abs(log2FoldChange)>2)
```

### edgeR

```R
library(edgeR)

dge <- DGEList(counts=expr,group=group_list)
keep <- rowSums(cpm(dge)>1) >= 2
dge <- dge[keep,keep.lib.sizes=FALSE]
dge$samples$lib.size <- colSums(dge$counts)
dge <- calcNormFactors(dge) 

design <- model.matrix(~0+group_list)
rownames(design)<-colnames(dge)
colnames(design)<-levels(group_list)

dge <- estimateGLMCommonDisp(dge,design)
dge <- estimateGLMTrendedDisp(dge, design)
dge <- estimateGLMTagwiseDisp(dge, design)

fit <- glmFit(dge, design)
fit2 <- glmLRT(fit, contrast=c(-1,1)) 

DEG_edgeR <- topTags(fit2, n=nrow(expr))
DEG_edgeR=as.data.frame(DEG_edgeR)
logFC_cutoff <- with(DEG_edgeR,mean(abs(logFC)) + 2*sd(abs(logFC)) )
#logFC_cutoff <- 2
DEG_edgeR$change = as.factor(
  ifelse(DEG_edgeR$FDR < 0.05 & abs(DEG_edgeR$logFC) > logFC_cutoff,
         ifelse(DEG_edgeR$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_edgeR <- subset(DEG_edgeR,FDR<0.05 & abs(logFC)>2)
```

### limma---1

```R
library(limma)

design <- model.matrix(~0+group_list)
colnames(design)=levels(group_list)
rownames(design)=colnames(expr)

dge <- DGEList(counts=expr)
dge <- calcNormFactors(dge)
logCPM <- cpm(dge, log=TRUE, prior.count=3)

v <- voom(dge,design, normalize="quantile")
fit <- lmFit(v, design)

constrasts = paste(rev(levels(group_list)),collapse = "-")
cont.matrix <- makeContrasts(contrasts=constrasts,levels = design) 
fit2=contrasts.fit(fit,cont.matrix)
fit2=eBayes(fit2)

DEG_limma = topTable(fit2, coef=constrasts, n=Inf)
DEG_limma = na.omit(DEG_limma)
#logFC_cutoff <- with(DEG_limma,mean(abs(logFC)) + 2*sd(abs(logFC)) )
logFC_cutoff <- 2
DEG_limma$change = as.factor(
  ifelse(DEG_limma$adj.P.Val < 0.05 & abs(DEG_limma$logFC) > logFC_cutoff,
         ifelse(DEG_limma$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_limma <- subset(DEG_limma,adj.P.Val<0.05 & abs(logFC)>2)
```

### limma---2

```R
library(limma)
expr.df <- read.table(file = "GSE42872_series_matrix.txt.gz", header =TRUE,
                      comment.char = "!")
library(hugene10sttranscriptcluster.db)
k <- as.character(expr.df$ID_REF)
out <- select(hugene10sttranscriptcluster.db,keys=k,
              columns=c('SYMBOL','GENENAME'),keytype='PROBEID')
out <- na.omit(out)
expr.df$symbol <- out[match(expr.df$ID_REF,out$PROBEID),2]
expr.df <- na.omit(expr.df)
expr.df <- dplyr::filter(expr.df,!duplicated(expr.df$symbol))
rownames(expr.df) <- expr.df$symbol
expr.df <- expr.df[,-ncol(expr.df)]
expr.df <- expr.df[,-1]
group <- c(rep("con",3),rep("treat",3))
group <- factor(group,levels = c("con","treat"),ordered = F)
design <- model.matrix(~group)
colnames(design) <- levels(group)
fit <- lmFit(expr.df,design)
fit2 <- eBayes(fit)
allDiff=topTable(fit2,adjust='fdr',coef=2,number=Inf)
diffLab <- subset(allDiff,abs(logFC) >1 & adj.P.Val < 0.05)
```

### GDCRNATools--R包：an R/Bioconductor package for downloading, organizing, and integrative analyzing lncRNA, mRNA, and miRNA data in GDC

https://github.com/Jialab-UCR/GDCRNATools

```R
library(GDCRNATools)
#mRNA的表达矩阵
data(rnaCounts)
#临床信息
metaMatrix.RNA <- gdcParseMetadata(project.id = 'TCGA-CHOL',
                                   data.type  = 'RNAseq',
                                   write.meta = FALSE)
metaMatrix.RNA <- gdcFilterDuplicate(metaMatrix.RNA)
metaMatrix.RNA <- gdcFilterSampleType(metaMatrix.RNA)
#过滤
rnaExpr <- gdcVoomNormalization(counts = rnaCounts, filter = FALSE)
#差异分析
DEGAll <- gdcDEAnalysis(counts     = rnaCounts, 
                        group      = metaMatrix.RNA$sample_type, 
                        comparison = 'PrimaryTumor-SolidTissueNormal', 
                        method     = 'limma')
dePC <- gdcDEReport(deg = DEGAll, gene.type = 'protein_coding')
#两个基因的相关性图
gdcCorPlot(gene1    = 'ENSG00000003989', 
           gene2    = 'ENSG00000004799', 
           rna.expr = rnaExpr, 
           metadata = metaMatrix.RNA)
#生存分析：两种方法---coxph、KM
survOutput1 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'coxph', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA)
survOutput2 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'KM', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA, 
                                  sep      = 'median')
gdcKMPlot(gene     = 'ENSG00000003989',
          rna.expr = rnaExpr,
          metadata = metaMatrix.RNA,
          sep      = 'median')
```

<<<<<<< HEAD
```R
library(data.table)
esca_expr <- fread('fanai/TCGA-ESCA.htseq_counts.tsv')
=======
### 消化道肿瘤ESTIMATE差异分析

```R
#COAD
library(data.table)
coad_expr <- fread('fanai/COAD/TCGA-COAD.htseq_counts.tsv')
#coad_surv <- fread('fanai/COAD/TCGA-COAD.survival.tsv')
coad_surv_d <- fread('fanai/COAD/COAD_survival.txt')
library(tibble)
coad_expr <- column_to_rownames(coad_expr,'Ensembl_ID')
coad_expr_lie <- colnames(coad_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(coad_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=coad_expr_lie,group=group_list)
tumor <- coad_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/COAD/coad_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','coad_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/COAD/coad_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_coad = res[order(res$pvalue),]
#write.csv(res_coad,file="chayi_gene_coad.csv")
diff_coad <- subset(res_coad,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_coad,file="fanai/COAD/chayi_coad2.csv")


#ESCA
library(data.table)
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
library(tibble)
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
esca_expr_lie <- colnames(esca_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(esca_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=esca_expr_lie,group=group_list)
tumor <- esca_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
<<<<<<< HEAD
write.table(tumor,file='fanai/esca_tumor.txt',sep='\t')
=======
write.table(tumor,file='fanai/ESCA/esca_tumor.txt',sep='\t')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','esca_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/ESCA/esca_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
<<<<<<< HEAD
res = results(dds, contrast=c("condition", "high", "low"),alpha = 0.05)
res_esca = res[order(res$padj),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
DESeq_norm_for_survial <- expr_norm[diff_esca@rownames,]
clinical <- fread('fanai/TCGA-ESCA.survival.tsv')
survival_cancer <- clinical
data <- t(DESeq_norm_for_survial)
survival_cancer <- column_to_rownames(survival_cancer,'sample')
jiaoji <- intersect(rownames(data),rownames(survival_cancer))
data <- data[jiaoji,]
survival_cancer <- survival_cancer[jiaoji,]
survival_cancer <- cbind(survival_cancer,data)
colnames(survival_cancer) <- gsub(colnames(survival_cancer),pattern = '-',replacement = '_')
uni_cox_bulk <- function(gene_list,survival_info_df){
  library(survival)
  gene_list <- gsub(gene_list,pattern = '-',replacement = '_')
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(OS.time,OS)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_cancer))
    ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    if(surv_uni_cox$coefficients[,5] < 0.05 & ph_hypothesis_p > 0.05){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
uni_cox_df <- uni_cox_bulk(gene_list = diff_esca@rownames,survival_info_df = survival_cancer)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca2.csv")
=======
res = results(dds, contrast=c("condition", "high", "low"))
res_esca = res[order(res$pvalue),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca2.csv")


#READ
library(data.table)
read_expr <- fread('fanai/READ/TCGA-READ.htseq_counts.tsv')
library(tibble)
read_expr <- column_to_rownames(read_expr,'Ensembl_ID')
read_expr_lie <- colnames(read_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(read_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=read_expr_lie,group=group_list)
tumor <- read_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/READ/read_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','read_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/READ/read_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_read = res[order(res$pvalue),]
diff_read <- subset(res_read,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_read,file="fanai/READ/chayi_read2.csv")

#STAD
library(data.table)
stad_expr <- fread('fanai/STAD/TCGA-STAD.htseq_counts.tsv')
library(tibble)
stad_expr <- column_to_rownames(stad_expr,'Ensembl_ID')
stad_expr_lie <- colnames(stad_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(stad_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=stad_expr_lie,group=group_list)
tumor <- stad_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/STAD/stad_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','stad_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/STAD/stad_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_stad = res[order(res$pvalue),]
diff_stad <- subset(res_stad,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_stad,file="fanai/STAD/chayi_stad2.csv")


#共同差异基因
coad <- read.csv('fanai/COAD/chayi_coad2.csv',row.names = 1)
esca <- read.csv('fanai/ESCA/chayi_esca2.csv',row.names = 1)
read <- read.csv('fanai/READ/chayi_read2.csv',row.names = 1)
stad <- read.csv('fanai/STAD/chayi_stad2.csv',row.names = 1)
#上调共差异
coad_s <- rownames(coad[coad$log2FoldChange>1.5,])
esca_s <- rownames(esca[esca$log2FoldChange>1.5,])
read_s <- rownames(read[read$log2FoldChange>1.5,])
stad_s <- rownames(stad[stad$log2FoldChange>1.5,])
a <- intersect(coad_s,esca_s)
b <- intersect(read_s,stad_s)
c <- intersect(a,b)
#下调共差异
coad_x <- rownames(coad[coad$log2FoldChange < -1.5,])
esca_x <- rownames(esca[esca$log2FoldChange < -1.5,])
read_x <- rownames(read[read$log2FoldChange < -1.5,])
stad_x <- rownames(stad[stad$log2FoldChange < -1.5,])
d <- intersect(coad_x,esca_x)
e <- intersect(read_x,stad_x)
f <- intersect(d,e)

#筛选免疫基因
mianyijiyin <- fread('免疫基因.txt')
mianyijiyin <- mianyijiyin$Symbol
shaixuan <- intersect(mianyijiyin,c)
write.csv(shaixuan,file='fanai/shaixuandemianyi.csv')


#火山图
load('fanai/ESCA/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_esca <- as.data.frame(res_esca)
library(ggplot2)
ggplot(data=res_esca, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_esca,abs(res_esca$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_esca,res_esca$padj < 0.05 & res_esca$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_esca,res_esca$padj < 0.05 & res_esca$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/COAD/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_coad <- as.data.frame(res_coad)
library(ggplot2)
ggplot(data=res_coad, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_coad,abs(res_coad$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_coad,res_coad$padj < 0.05 & res_coad$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_coad,res_coad$padj < 0.05 & res_coad$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/READ/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_read <- as.data.frame(res_read)
library(ggplot2)
ggplot(data=res_read, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_read,abs(res_read$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_read,res_read$padj < 0.05 & res_read$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_read,res_read$padj < 0.05 & res_read$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

load('fanai/STAD/shuju.RData')
#res_coad$gene <- rownames(res_coad)
res_stad <- as.data.frame(res_stad)
library(ggplot2)
ggplot(data=res_stad, aes(x=log2FoldChange, y =-log10(padj))) +        
  ## 三个部分分别画点        
  geom_point(data=subset(res_stad,abs(res_stad$log2FoldChange) < 1.5), color="black") +        
  geom_point(data=subset(res_stad,res_stad$padj < 0.05 & res_stad$log2FoldChange > 1.5), color="red") + 
  geom_point(data=subset(res_stad,res_stad$padj < 0.05 & res_stad$log2FoldChange < -1.5), color="green") +        
  ## 画线        
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+        
  geom_vline(xintercept = c(1.5,-1.5),lty=4,lwd=0.6,alpha=0.8)+        
  ## 主题        
  theme_classic()+        
  labs(x="log2 (fold change)",y="-log10 (q-value)")

#提取免疫基因在四种癌症中的表达量
esca_immune_expr <- tumor[shaixuan,]
save(esca_immune_expr,file='fanai/escaie.Rdata')
load('fanai/COAD/shuju.RData')
load('fanai/gongtongchayi.RData')
coad_immune_expr <- tumor[shaixuan,]
save(coad_immune_expr,file='fanai/coadie.Rdata')
load('fanai/READ/shuju.RData')
read_immune_expr <- tumor[shaixuan,]
save(read_immune_expr,file='fanai/readie.Rdata')
load('fanai/STAD/shuju.RData')
stad_immune_expr <- tumor[shaixuan,]
save(stad_immune_expr,file='fanai/stadie.Rdata')

#合并免疫表达数据和OS临床数据
load('fanai/coadie.Rdata')
load('fanai/escaie.Rdata')
load('fanai/readie.Rdata')
load('fanai/stadie.Rdata')
library(data.table)
library(dplyr)
esca_immune_expr <- t(esca_immune_expr)
esca_surv_d <- fread('fanai/ESCA/ESCA_survival.txt')
esca_surv_d$sample <- paste(esca_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(esca_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,esca_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
esca_immune_expr <- esca_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(esca_immune_expr),rownames(sampleid_pipei))
esca_immune_expr_clin <- cbind(sampleid_pipei,esca_immune_expr)
save(esca_immune_expr_clin,file='fanai/esca-immune-expr-clin.Rdata')

stad_immune_expr <- t(stad_immune_expr)
stad_surv_d <- fread('fanai/STAD/STAD_survival.txt')
stad_surv_d$sample <- paste(stad_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(stad_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,stad_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
stad_immune_expr <- stad_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(stad_immune_expr),rownames(sampleid_pipei))
stad_immune_expr_clin <- cbind(sampleid_pipei,stad_immune_expr)
save(stad_immune_expr_clin,file='fanai/stad-immune-expr-clin.Rdata')

read_immune_expr <- t(read_immune_expr)
read_surv_d <- fread('fanai/READ/READ_survival.txt')
read_surv_d$sample <- paste(read_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(read_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,read_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
read_immune_expr <- read_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(read_immune_expr),rownames(sampleid_pipei))
read_immune_expr_clin <- cbind(sampleid_pipei,read_immune_expr)
save(read_immune_expr_clin,file='fanai/read-immune-expr-clin.Rdata')

coad_immune_expr <- t(coad_immune_expr)
coad_surv_d <- fread('fanai/COAD/COAD_survival.txt')
coad_surv_d$sample <- paste(coad_surv_d$sample,'A',sep="")
sampleid <- data.frame(sample=rownames(coad_immune_expr),stringsAsFactors = F)
sampleid_pipei <- left_join(sampleid,coad_surv_d,by='sample')
sampleid_pipei <- sampleid_pipei[,-c(2,5:11)]
sampleid_pipei <- na.omit(sampleid_pipei)
coad_immune_expr <- coad_immune_expr[sampleid_pipei$sample,]
rownames(sampleid_pipei) <- sampleid_pipei[,1]
sampleid_pipei <- sampleid_pipei[,-1]
identical(rownames(coad_immune_expr),rownames(sampleid_pipei))
coad_immune_expr_clin <- cbind(sampleid_pipei,coad_immune_expr)
save(coad_immune_expr_clin,file='fanai/coad-immune-expr-clin.Rdata')
>>>>>>> 27538607274e5c39afd7db43bd93502bd4adbe1a
```

#### 差异基因的单因素cox

```R
library(data.table)
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
library(tibble)
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
esca_expr_lie <- colnames(esca_expr)
#提取肿瘤样本表达数据
library(stringr)
tum <- c()
for(i in esca_expr_lie){
  if(str_sub(i,14,16) == '01A'){
    tum <- c(tum,i)
  }
}
tumor <- esca_expr[,tum]
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/ESCA/esca_tumor1.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','esca_tumor1.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/ESCA/esca_scores1.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_esca = res[order(res$pvalue),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca3.csv")
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
mianyi <- fread('免疫基因.txt')
shaixuan <- intersect(mianyi$Symbol,diff_esca@rownames)
DESeq_norm_for_survial <- expr_norm[shaixuan,]
clinical <- fread('fanai/ESCA/TCGA-ESCA.survival.tsv')
# cli_info <- fread('fanai/ESCA/TCGA-ESCA.GDC_phenotype.tsv')
# postoper <- cli_info$postoperative_rx_tx
# cli_info1 <- data.frame(postop=postoper,wu=NA)
# rownames(cli_info1) <- cli_info$submitter_id.samples
survival_cancer <- clinical
data <- t(DESeq_norm_for_survial)
survival_cancer <- column_to_rownames(survival_cancer,'sample')
survival_cancer <- survival_cancer[,-2]
jiaoji <- intersect(rownames(data),rownames(survival_cancer))
data <- data[jiaoji,]
survival_cancer <- survival_cancer[jiaoji,]
#cli_info1 <- cli_info1[jiaoji,]
colnames(survival_cancer) <- c('status','time')
#survival_cancer <- cbind(survival_cancer,cli_info1)
surv_expr <- cbind(survival_cancer,data)
colnames(surv_expr) <- gsub(colnames(surv_expr),pattern = '-',replacement = '_')
gene <- colnames(surv_expr)[3:ncol(surv_expr)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.05 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
library(survival)
tmp <- surv_expr
# shachu <- c('TCGA-L5-A8NU-01A')
# tmp <- tmp[!rownames(tmp) %in% shachu,]
tmp$status <- as.numeric(tmp$status)
tmp$time <- as.numeric(tmp$time)
tmp <- tmp[tmp$time<1500 & tmp$time > 90,]
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
```

#### 筛选差异基因--ESCA

```R
library(data.table)
esca_os <- fread('fanai/ESCA/TCGA-ESCA.survival.tsv')
esca_type <- fread('fanai/ESCA/TCGA-ESCA.GDC_phenotype.tsv')
esca_sample <- intersect(esca_os$sample,esca_type$submitter_id.samples)
library(tibble)
esca_os <- column_to_rownames(esca_os,'sample')
esca_type <- column_to_rownames(esca_type,'submitter_id.samples')
esca_os <- esca_os[esca_sample,]
esca_type <- esca_type[esca_sample,]
esca_os$follow <- esca_type$days_to_last_follow_up.diagnoses 
esca_os <- na.omit(esca_os)
esca_os <- esca_os[esca_os$follow > 2,]
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
esca_expr_lie <- colnames(esca_expr)
tum <- c()
library(dplyr)
library(stringr)
for(i in esca_expr_lie){
  if(str_sub(i,14,16) == '01A'){
    tum <- c(tum,i)
  }
}
tumor <- esca_expr[,tum]
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(tumor))
tumor <- tumor[bianma,]
sample_z <- intersect(colnames(tumor),rownames(esca_os))
tumor <- tumor[,sample_z]
esca_os <- esca_os[sample_z,]
write.table(tumor,file='fanai/ESCA/esca_tumor01A.txt',sep='\t')
library(estimate)
OvarianCancerExpr <- system.file('extdata','esca_tumor01A.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/ESCA/esca_scores01A.csv')
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_esca = res[order(res$pvalue),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
dim(diff_esca)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca01A.csv")
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
DESeq_norm_for_survial <- expr_norm[diff_esca@rownames,]
data <- t(DESeq_norm_for_survial)
gong <- intersect(rownames(data),rownames(esca_os))
data <- data[gong,]
esca_os <- esca_os[gong,]
esca_os <- esca_os[,-c(2,4)]
colnames(esca_os) <- c('status','time')
surv_expr <- cbind(esca_os,data)
colnames(surv_expr) <- gsub(colnames(surv_expr),pattern = '-',replacement = '_')
gene <- colnames(surv_expr)[3:ncol(surv_expr)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.05 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}

a <- survfit(Surv(time,status)~SRGN,data=tmp)
ggsurvplot(a, conf.int=F, pval=TRUE)
library(survival)
library(survminer)
tmp <- surv_expr
# shachu <- c('TCGA-L5-A8NU-01A')
# tmp <- tmp[!rownames(tmp) %in% shachu,]
tmp$status <- as.numeric(tmp$status)
tmp$time <- as.numeric(tmp$time)
tmp <- tmp[tmp$time<1500 & tmp$time > 90,]
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
```

#### 筛选差异基因--COAD

```R
library(data.table)
coad_os <- fread('fanai/COAD/TCGA-COAD.survival.tsv')
coad_type <- fread('fanai/COAD/TCGA-COAD.GDC_phenotype.tsv')
coad_sample <- intersect(coad_os$sample,coad_type$submitter_id.samples)
library(tibble)
coad_os <- column_to_rownames(coad_os,'sample')
coad_type <- column_to_rownames(coad_type,'submitter_id.samples')
coad_os <- coad_os[coad_sample,]
coad_type <- coad_type[coad_sample,]
coad_os$follow <- coad_type$days_to_last_follow_up.diagnoses 
coad_os <- na.omit(coad_os)
coad_os <- coad_os[coad_os$follow > 2,]
coad_expr <- fread('fanai/COAD/TCGA-COAD.htseq_counts.tsv')
coad_expr <- column_to_rownames(coad_expr,'Ensembl_ID')
coad_expr_lie <- colnames(coad_expr)
tum <- c()
library(dplyr)
library(stringr)
for(i in coad_expr_lie){
  if(str_sub(i,14,16) == '01A'){
    tum <- c(tum,i)
  }
}
tumor <- coad_expr[,tum]
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(tumor))
tumor <- tumor[bianma,]
sample_z <- intersect(colnames(tumor),rownames(coad_os))
tumor <- tumor[,sample_z]
coad_os <- coad_os[sample_z,]
write.table(tumor,file='fanai/COAD/coad_tumor01A.txt',sep='\t')
library(estimate)
OvarianCancerExpr <- system.file('extdata','coad_tumor01A.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/COAD/coad_scores01A.csv')
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_coad = res[order(res$pvalue),]
diff_coad <- subset(res_coad,padj<0.05 & abs(log2FoldChange)>1.5)
dim(diff_coad)
write.csv(diff_coad,file="fanai/COAD/chayi_coad01A.csv")
```

#### 筛选差异基因--READ

```R
library(data.table)
read_os <- fread('fanai/READ/TCGA-READ.survival.tsv')
read_type <- fread('fanai/READ/TCGA-READ.GDC_phenotype.tsv')
read_sample <- intersect(read_os$sample,read_type$submitter_id.samples)
library(tibble)
read_os <- column_to_rownames(read_os,'sample')
read_type <- column_to_rownames(read_type,'submitter_id.samples')
read_os <- read_os[read_sample,]
read_type <- read_type[read_sample,]
read_os$follow <- read_type$days_to_last_follow_up.diagnoses 
read_os <- na.omit(read_os)
read_os <- read_os[read_os$follow > 2,]
read_expr <- fread('fanai/READ/TCGA-READ.htseq_counts.tsv')
read_expr <- column_to_rownames(read_expr,'Ensembl_ID')
read_expr_lie <- colnames(read_expr)
tum <- c()
library(dplyr)
library(stringr)
for(i in read_expr_lie){
  if(str_sub(i,14,16) == '01A'){
    tum <- c(tum,i)
  }
}
tumor <- read_expr[,tum]
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(tumor))
tumor <- tumor[bianma,]
sample_z <- intersect(colnames(tumor),rownames(read_os))
tumor <- tumor[,sample_z]
read_os <- read_os[sample_z,]
write.table(tumor,file='fanai/READ/read_tumor01A.txt',sep='\t')
library(estimate)
OvarianCancerExpr <- system.file('extdata','read_tumor01A.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/READ/read_scores01A.csv')
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_read = res[order(res$pvalue),]
diff_read <- subset(res_read,padj<0.05 & abs(log2FoldChange)>1.5)
dim(diff_read)
write.csv(diff_read,file="fanai/READ/chayi_read01A.csv")
```

#### 筛选差异基因--STAD

```R
library(data.table)
stad_os <- fread('fanai/STAD/TCGA-STAD.survival.tsv')
stad_type <- fread('fanai/STAD/TCGA-STAD.GDC_phenotype.tsv')
stad_sample <- intersect(stad_os$sample,stad_type$submitter_id.samples)
library(tibble)
stad_os <- column_to_rownames(stad_os,'sample')
stad_type <- column_to_rownames(stad_type,'submitter_id.samples')
stad_os <- stad_os[stad_sample,]
stad_type <- stad_type[stad_sample,]
stad_os$follow <- stad_type$days_to_last_follow_up.diagnoses 
stad_os <- na.omit(stad_os)
stad_os <- stad_os[stad_os$follow > 2,]
stad_expr <- fread('fanai/STAD/TCGA-STAD.htseq_counts.tsv')
stad_expr <- column_to_rownames(stad_expr,'Ensembl_ID')
stad_expr_lie <- colnames(stad_expr)
tum <- c()
library(dplyr)
library(stringr)
for(i in stad_expr_lie){
  if(str_sub(i,14,16) == '01A'){
    tum <- c(tum,i)
  }
}
tumor <- stad_expr[,tum]
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(tumor))
tumor <- tumor[bianma,]
sample_z <- intersect(colnames(tumor),rownames(stad_os))
tumor <- tumor[,sample_z]
stad_os <- stad_os[sample_z,]
write.table(tumor,file='fanai/STAD/stad_tumor01A.txt',sep='\t')
library(estimate)
OvarianCancerExpr <- system.file('extdata','stad_tumor01A.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/STAD/stad_scores01A.csv')
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"))
res_stad = res[order(res$pvalue),]
diff_stad <- subset(res_stad,padj<0.05 & abs(log2FoldChange)>1.5)
dim(diff_stad)
write.csv(diff_stad,file="fanai/STAD/chayi_stad01A.csv")
```

#### 共同差异基因的单因素cox---coad

```R
load('fanai/COAD/chayijiyin.RData')
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
coad_surv <- expr_norm[c,]
coad_os <- coad_os[,-c(2,4)]
colnames(coad_os) <- c('status','time')
coad_surv <- t(coad_surv)
coad_surv <- as.data.frame(coad_surv)
coad_surv <- coad_surv[sample_z,]
coad_expr_surv <- cbind(coad_os,coad_surv)
colnames(coad_expr_surv) <- gsub(colnames(coad_expr_surv),
                            pattern = '-',replacement = '_')
gene <- colnames(coad_expr_surv)[3:ncol(coad_expr_surv)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.15 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
library(survival)
library(survminer)
tmp <- coad_expr_surv
# shachu <- c('TCGA-L5-A8NU-01A')
# tmp <- tmp[!rownames(tmp) %in% shachu,]
tmp$status <- as.numeric(tmp$status)
tmp$time <- as.numeric(tmp$time)
tmp <- tmp[tmp$time<1500 & tmp$time > 90,]
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
save.image("D:/linshiwenjian/r-daima/fanai/COAD/dan_cox.RData")
```

#### 筛选癌症样本与正常样本的差异基因--COAD

```R
coad_expr <- fread('fanai/COAD/TCGA-COAD.htseq_counts.tsv')
coad_expr <- column_to_rownames(coad_expr,'Ensembl_ID')

surv <- fread('fanai/COAD/TCGA-COAD.survival.tsv')
surv <- column_to_rownames(surv,'sample')
jiao <- intersect(colnames(coad_expr),rownames(surv))
coad_expr <- coad_expr[,jiao]

idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(coad_expr), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
coad_expr <- coad_expr[geneid2symbol$id,]
rownames(coad_expr) <- geneid2symbol$gene

tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(coad_expr))
coad_expr <- coad_expr[bianma,]
coad_expr_lie <- colnames(coad_expr)
tum <- c()
nor <- c()
library(dplyr)
library(stringr)
for(i in coad_expr_lie){
  if(as.numeric(str_sub(i,14,15)) < 10){
    tum <- c(tum,i)
  }
  else{
    nor <- c(nor,i)
  }
}
tumor <- coad_expr[,tum]
normal <- coad_expr[,nor]

t_n_sample <- cbind(tumor,normal)
t_n_sample <- 2^t_n_sample-1
t_n_sample <- round(t_n_sample)
library(DESeq2)
condition <- factor(c(rep("tumor",length(tum)),rep("normal",length(nor))), levels = c("tumor","normal"))
colData <- data.frame(row.names=colnames(t_n_sample), condition)
dds <- DESeqDataSetFromMatrix(t_n_sample, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "tumor", "normal"))
res_coad = res[order(res$pvalue),]
diff_coad <- subset(res_coad,padj < 0.05 & abs(log2FoldChange) > 1.5)
dim(diff_coad)
write.csv(diff_coad,file="fanai/T_N_jieguo/chayi_coad_T_N.csv")
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/chayijiyin_coad_T_N.RData")
```

#### 筛选癌症样本与正常样本的差异基因--ESCA

```R
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')

surv <- fread('fanai/ESCA/TCGA-ESCA.survival.tsv')
surv <- column_to_rownames(surv,'sample')
jiao <- intersect(colnames(esca_expr),rownames(surv))
esca_expr <- esca_expr[,jiao]

idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(esca_expr), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
esca_expr <- esca_expr[geneid2symbol$id,]
rownames(esca_expr) <- geneid2symbol$gene

tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(esca_expr))
esca_expr <- esca_expr[bianma,]
esca_expr_lie <- colnames(esca_expr)
tum <- c()
nor <- c()
for(i in esca_expr_lie){
  if(as.numeric(str_sub(i,14,15)) < 10){
    tum <- c(tum,i)
  }
  else{
    nor <- c(nor,i)
  }
}
tumor <- esca_expr[,tum]
normal <- esca_expr[,nor]

t_n_sample <- cbind(tumor,normal)
t_n_sample <- 2^t_n_sample-1
t_n_sample <- round(t_n_sample)
condition <- factor(c(rep("tumor",length(tum)),rep("normal",length(nor))), levels = c("tumor","normal"))
colData <- data.frame(row.names=colnames(t_n_sample), condition)
dds <- DESeqDataSetFromMatrix(t_n_sample, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "tumor", "normal"))
res_esca = res[order(res$pvalue),]
diff_esca <- subset(res_esca,padj < 0.05 & abs(log2FoldChange) > 1.5)
dim(diff_esca)
write.csv(diff_esca,file="fanai/T_N_jieguo/chayi_esca_T_N.csv")
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/chayijiyin_esca_T_N.RData")
```

#### 筛选癌症样本与正常样本的差异基因--STAD

```R
stad_expr <- fread('fanai/STAD/TCGA-STAD.htseq_counts.tsv')
stad_expr <- column_to_rownames(stad_expr,'Ensembl_ID')

surv <- fread('fanai/STAD/TCGA-STAD.survival.tsv')
surv <- column_to_rownames(surv,'sample')
jiao <- intersect(colnames(stad_expr),rownames(surv))
stad_expr <- stad_expr[,jiao]

idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(stad_expr), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
stad_expr <- stad_expr[geneid2symbol$id,]
rownames(stad_expr) <- geneid2symbol$gene

tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(stad_expr))
stad_expr <- stad_expr[bianma,]
stad_expr_lie <- colnames(stad_expr)
tum <- c()
nor <- c()
for(i in stad_expr_lie){
  if(as.numeric(str_sub(i,14,15)) < 10){
    tum <- c(tum,i)
  }
  else{
    nor <- c(nor,i)
  }
}
tumor <- stad_expr[,tum]
normal <- stad_expr[,nor]

t_n_sample <- cbind(tumor,normal)
t_n_sample <- 2^t_n_sample-1
t_n_sample <- round(t_n_sample)
condition <- factor(c(rep("tumor",length(tum)),rep("normal",length(nor))), levels = c("tumor","normal"))
colData <- data.frame(row.names=colnames(t_n_sample), condition)
dds <- DESeqDataSetFromMatrix(t_n_sample, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "tumor", "normal"))
res_stad = res[order(res$pvalue),]
diff_stad <- subset(res_stad,padj < 0.05 & abs(log2FoldChange) > 1.5)
dim(diff_stad)
write.csv(diff_stad,file="fanai/T_N_jieguo/chayi_stad_T_N.csv")
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/chayijiyin_stad_T_N.RData")
```

#### 筛选癌症样本与正常样本的差异基因--READ

```R
read_expr <- fread('fanai/READ/TCGA-READ.htseq_counts.tsv')
read_expr <- column_to_rownames(read_expr,'Ensembl_ID')

surv <- fread('fanai/READ/TCGA-READ.survival.tsv')
surv <- column_to_rownames(surv,'sample')
jiao <- intersect(colnames(read_expr),rownames(surv))
read_expr <- read_expr[,jiao]

idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(read_expr), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
read_expr <- read_expr[geneid2symbol$id,]
rownames(read_expr) <- geneid2symbol$gene

tmp <- load('fanai/anno.rda')
bianma <- intersect(mRNA_anno$gene_name,rownames(read_expr))
read_expr <- read_expr[bianma,]
read_expr_lie <- colnames(read_expr)
tum <- c()
nor <- c()
for(i in read_expr_lie){
  if(as.numeric(str_sub(i,14,15)) < 10){
    tum <- c(tum,i)
  }
  else{
    nor <- c(nor,i)
  }
}
tumor <- read_expr[,tum]
normal <- read_expr[,nor]

t_n_sample <- cbind(tumor,normal)
t_n_sample <- 2^t_n_sample-1
t_n_sample <- round(t_n_sample)
condition <- factor(c(rep("tumor",length(tum)),rep("normal",length(nor))), levels = c("tumor","normal"))
colData <- data.frame(row.names=colnames(t_n_sample), condition)
dds <- DESeqDataSetFromMatrix(t_n_sample, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "tumor", "normal"))
res_read = res[order(res$pvalue),]
diff_read <- subset(res_read,padj < 0.05 & abs(log2FoldChange) > 1.5)
dim(diff_read)
write.csv(diff_read,file="fanai/T_N_jieguo/chayi_read_T_N.csv")
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/chayijiyin_read_T_N.RData")
```

#### 共同差异基因

```R
coad <- read.csv('fanai/T_N_jieguo/chayi_coad_T_N.csv',row.names = 1)
esca <- read.csv('fanai/T_N_jieguo/chayi_esca_T_N.csv',row.names = 1)
read <- read.csv('fanai/T_N_jieguo/chayi_read_T_N.csv',row.names = 1)
stad <- read.csv('fanai/T_N_jieguo/chayi_stad_T_N.csv',row.names = 1)
#上调共差异
coad_s <- rownames(coad[coad$log2FoldChange > 1.5,])
esca_s <- rownames(esca[esca$log2FoldChange > 1.5,])
read_s <- rownames(read[read$log2FoldChange > 1.5,])
stad_s <- rownames(stad[stad$log2FoldChange > 1.5,])
a <- intersect(coad_s,esca_s)
b <- intersect(read_s,stad_s)
c <- intersect(a,b)
#下调共差异
coad_x <- rownames(coad[coad$log2FoldChange < -1.5,])
esca_x <- rownames(esca[esca$log2FoldChange < -1.5,])
read_x <- rownames(read[read$log2FoldChange < -1.5,])
stad_x <- rownames(stad[stad$log2FoldChange < -1.5,])
d <- intersect(coad_x,esca_x)
e <- intersect(read_x,stad_x)
f <- intersect(d,e)
write.csv(c,file = 'fanai/T_N_jieguo/gongtong_s.csv')
write.csv(f,file = 'fanai/T_N_jieguo/gongtong_x.csv')
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/gongtongchayi_T_N.RData")

#每两种癌症以及四种癌症的共同差异---foldchange=1.5
coad <- read.csv('fanai/T_N_jieguo/chayi_coad_T_N_1.5.csv',stringsAsFactors = F,row.names = 1)
esca <- read.csv('fanai/T_N_jieguo/chayi_esca_T_N_1.5.csv',stringsAsFactors = F,row.names = 1)
read <- read.csv('fanai/T_N_jieguo/chayi_read_T_N_1.5.csv',stringsAsFactors = F,row.names = 1)
stad <- read.csv('fanai/T_N_jieguo/chayi_stad_T_N_1.5.csv',stringsAsFactors = F,row.names = 1)
ce <- intersect(rownames(coad),rownames(esca))
cr <- intersect(rownames(coad),rownames(read))
cs <- intersect(rownames(coad),rownames(stad))
er <- intersect(rownames(esca),rownames(read))
es <- intersect(rownames(esca),rownames(stad))
rs <- intersect(rownames(read),rownames(stad))
cers <- intersect(ce,rs)
save.image("D:/linshiwenjian/r-daima/fanai/T_N_jieguo/gongtongchayi_T_N_1.5.RData")
```

#### 筛选共同免疫基因

```R
mianyijiyin <- fread('免疫基因.txt')
mianyijiyin <- dplyr::filter(mianyijiyin,!duplicated(mianyijiyin$Symbol))
mianyijiyin <- mianyijiyin$Symbol
s <- read.csv('fanai/T_N_jieguo/gongtong_s.csv',stringsAsFactors = F)
x <- read.csv('fanai/T_N_jieguo/gongtong_x.csv',stringsAsFactors = F)
shaixuan_s <- intersect(mianyijiyin,s$x)
shaixuan_x <- intersect(mianyijiyin,x$x)
shaixuan <- c(shaixuan_s,shaixuan_x)
write.csv(shaixuan,file='fanai/T_N_jieguo/gongtongmianyijiyin_T_N.csv')
```

#### 单因素cox---COAD

```R
jiyin <- read.csv('fanai/T_N_jieguo/gongtongmianyijiyin_T_N.csv',stringsAsFactors = F)
load('fanai/T_N_jieguo/chayijiyin_coad_T_N.RData')
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
coad_surv <- expr_norm[,tum]
dim(coad_surv)
coad_surv <- coad_surv[jiyin$x,]
jiao <- intersect(colnames(coad_surv),rownames(surv))
coad_surv <- coad_surv[,jiao]
surv <- surv[jiao,]
coad_surv <- t(coad_surv)
surv <- surv[,-2]
colnames(surv) <- c('status','time')
identical(rownames(coad_surv),rownames(surv))
coad_surv_exp <- cbind(surv,coad_surv)

colnames(coad_surv_exp) <- gsub(colnames(coad_surv_exp),
                                pattern = '-',replacement = '_')
gene <- colnames(coad_surv_exp)[3:ncol(coad_surv_exp)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.15 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
library(survival)
library(survminer)
tmp <- coad_surv_exp
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
write.csv(uni_cox_df,file='fanai/T_N_jieguo/coad_dan_cox.csv')
```

#### 单因素cox---ESCA

```R
jiyin <- read.csv('fanai/T_N_jieguo/gongtongmianyijiyin_T_N.csv',stringsAsFactors = F)
load('fanai/T_N_jieguo/chayijiyin_esca_T_N.RData')
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
esca_surv <- expr_norm[,tum]
dim(esca_surv)
esca_surv <- esca_surv[jiyin$x,]
jiao <- intersect(colnames(esca_surv),rownames(surv))
esca_surv <- esca_surv[,jiao]
surv <- surv[jiao,]
esca_surv <- t(esca_surv)
surv <- surv[,-2]
colnames(surv) <- c('status','time')
identical(rownames(esca_surv),rownames(surv))
esca_surv_exp <- cbind(surv,esca_surv)

colnames(esca_surv_exp) <- gsub(colnames(esca_surv_exp),
                                pattern = '-',replacement = '_')
gene <- colnames(esca_surv_exp)[3:ncol(esca_surv_exp)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.15 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
tmp <- esca_surv_exp
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
write.csv(uni_cox_df,file='fanai/T_N_jieguo/esca_dan_cox.csv')
```

#### 单因素cox---READ

```R
jiyin <- read.csv('fanai/T_N_jieguo/gongtongmianyijiyin_T_N.csv',stringsAsFactors = F)
load('fanai/T_N_jieguo/chayijiyin_read_T_N.RData')
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
read_surv <- expr_norm[,tum]
dim(read_surv)
read_surv <- read_surv[jiyin$x,]
jiao <- intersect(colnames(read_surv),rownames(surv))
read_surv <- read_surv[,jiao]
surv <- surv[jiao,]
read_surv <- t(read_surv)
surv <- surv[,-2]
colnames(surv) <- c('status','time')
identical(rownames(read_surv),rownames(surv))
read_surv_exp <- cbind(surv,read_surv)

colnames(read_surv_exp) <- gsub(colnames(read_surv_exp),
                                pattern = '-',replacement = '_')
gene <- colnames(read_surv_exp)[3:ncol(read_surv_exp)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.15 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
tmp <- read_surv_exp
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
write.csv(uni_cox_df,file='fanai/T_N_jieguo/read_dan_cox.csv')
```

#### 单因素cox---STAD

```R
jiyin <- read.csv('fanai/T_N_jieguo/gongtongmianyijiyin_T_N.csv',stringsAsFactors = F)
load('fanai/T_N_jieguo/chayijiyin_stad_T_N.RData')
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
stad_surv <- expr_norm[,tum]
dim(stad_surv)
stad_surv <- stad_surv[jiyin$x,]
jiao <- intersect(colnames(stad_surv),rownames(surv))
stad_surv <- stad_surv[,jiao]
surv <- surv[jiao,]
stad_surv <- t(stad_surv)
surv <- surv[,-2]
colnames(surv) <- c('status','time')
identical(rownames(stad_surv),rownames(surv))
stad_surv_exp <- cbind(surv,stad_surv)

colnames(stad_surv_exp) <- gsub(colnames(stad_surv_exp),
                                pattern = '-',replacement = '_')
gene <- colnames(stad_surv_exp)[3:ncol(stad_surv_exp)]
uni_cox_bulk <- function(gene_list,survival_info_df){
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(time,status)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_info_df))
    #ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    #& ph_hypothesis_p > 0.05
    if(surv_uni_cox$coefficients[,5] < 0.15 ){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'HR.confint.lower'=surv_uni_cox$conf.int[,"lower .95"],
                                      'HR.confint.upper'=surv_uni_cox$conf.int[,"upper .95"],
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
tmp <- stad_surv_exp
uni_cox_df <- uni_cox_bulk(gene_list = gene,survival_info_df = tmp)
write.csv(uni_cox_df,file='fanai/T_N_jieguo/stad_dan_cox.csv')
```

#### COAD森林图

```R
coad <- read.csv('fanai/T_N_jieguo/coad_dan_cox.csv',stringsAsFactors = F,row.names = 1)
hz <- paste(round(coad$Hazard_Ratio,3),
            " (",round(coad$HR.confint.lower,3),
            "-",round(coad$HR.confint.upper,3),")",sep = "")
tabletext <- cbind(c(NA,"Gene",coad$gene_name),
                   #c(NA,"Coefficient",round(coad$coef,3)),
                   #c(NA,"P value",ifelse(coad$pvalue<0.001,"P < 0.001",round(coad$pvalue,3))),
                   c(NA,"Hazard Ratio(95% CI)",hz))

nrow(tabletext)+1
library(forestplot)
forestplot(labeltext=tabletext,
           graph.pos=3,  #为Pvalue箱线图所在的位置
           col=fpColors(box="#D55E00", lines="#CC79A7", zero = "gray50"),
           # col=fpColors(box=c("royalblue", "gold"),
           #              line=c("darkblue", "orange"),
           #              summary=c("darkblue", "red")),
           mean=c(NA,NA,coad$Hazard_Ratio),
           lower=c(NA,NA,coad$HR.confint.lower), #95%置信区间下限
           upper=c(NA,NA,coad$HR.confint.upper), #95%置信区间上限
           boxsize=0.4,lwd.ci=2,   #箱子大小，线的宽度
           ci.vertices.height = 0.2,ci.vertices=TRUE, #置信区间用线宽、高、型
           zero=1,lwd.zero=1,      #zero线宽 基准线的位置
           colgap=unit(5,"mm"),    #列间隙
           xticks = c(0, 1,3), #横坐标刻度
           lwd.xaxis=2,            #X轴线宽
           lineheight = unit(0.8,"cm"), #固定行高
           graphwidth = unit(.3,"npc"), #图在表中的宽度比例
           cex=0.9, fn.ci_norm = fpDrawCircleCI, #误差条显示方式
           hrzl_lines=list("2" = gpar(lwd=2, col="blue"),
                           "3" = gpar(lwd=2, col="blue"), #第三行顶部加黑线，引号内数字标记行位置
                           "16" = gpar(lwd=2, col="blue")
                           ),#最后一行底部加黑线,"34"中数字为nrow(tabletext)+1
           #mar=unit(rep(0.5, times = 4), "cm"),#图形页边距
           #fpTxtGp函数中的cex参数设置各个组件的大小
           txt_gp=fpTxtGp(label=gpar(cex=1.5),
                          ticks=gpar(cex=1.5),
                          xlab=gpar(cex = 1.25),
                          title=gpar(cex = 1.2)),
           #xlab="Hazard Ratio",
           )
```

#### ESCA森林图

```R
esca <- read.csv('fanai/T_N_jieguo/esca_dan_cox.csv',stringsAsFactors = F,row.names = 1)
hz <- paste(round(esca$Hazard_Ratio,3),
            " (",round(esca$HR.confint.lower,3),
            "-",round(esca$HR.confint.upper,3),")",sep = "")
tabletext <- cbind(c(NA,"Gene",esca$gene_name),
                   c(NA,"Hazard Ratio(95% CI)",hz))

nrow(tabletext)+1
library(forestplot)
forestplot(labeltext=tabletext,
           graph.pos=3,  #为Pvalue箱线图所在的位置
           col=fpColors(box="#D55E00", lines="#CC79A7", zero = "gray50"),
           # col=fpColors(box=c("royalblue", "gold"),
           #              line=c("darkblue", "orange"),
           #              summary=c("darkblue", "red")),
           mean=c(NA,NA,esca$Hazard_Ratio),
           lower=c(NA,NA,esca$HR.confint.lower), #95%置信区间下限
           upper=c(NA,NA,esca$HR.confint.upper), #95%置信区间上限
           boxsize=0.4,lwd.ci=2,   #箱子大小，线的宽度
           ci.vertices.height = 0.2,ci.vertices=TRUE, #置信区间用线宽、高、型
           zero=1,lwd.zero=1,      #zero线宽 基准线的位置
           colgap=unit(5,"mm"),    #列间隙
           xticks = c(0, 1,4.5), #横坐标刻度
           lwd.xaxis=2,            #X轴线宽
           lineheight = unit(0.8,"cm"), #固定行高
           graphwidth = unit(.3,"npc"), #图在表中的宽度比例
           cex=0.9, fn.ci_norm = fpDrawCircleCI, #误差条显示方式
           hrzl_lines=list("2" = gpar(lwd=2, col="blue"),
                           "3" = gpar(lwd=2, col="blue"), #第三行顶部加黑线，引号内数字标记行位置
                           "18" = gpar(lwd=2, col="blue")
                           ),#最后一行底部加黑线,"34"中数字为nrow(tabletext)+1
           #mar=unit(rep(0.5, times = 4), "cm"),#图形页边距
           #fpTxtGp函数中的cex参数设置各个组件的大小
           txt_gp=fpTxtGp(label=gpar(cex=1.5),
                          ticks=gpar(cex=1.5),
                          xlab=gpar(cex = 1.25),
                          title=gpar(cex = 1.2)),
           #xlab="Hazard Ratio",
           )
```

#### READ森林图

```R
read <- read.csv('fanai/T_N_jieguo/read_dan_cox.csv',stringsAsFactors = F,row.names = 1)
hz <- paste(round(read$Hazard_Ratio,3),
            " (",round(read$HR.confint.lower,3),
            "-",round(read$HR.confint.upper,3),")",sep = "")
tabletext <- cbind(c(NA,"Gene",read$gene_name),
                   c(NA,"Hazard Ratio(95% CI)",hz))

nrow(tabletext)+1
library(forestplot)
forestplot(labeltext=tabletext,
           graph.pos=3,  #为Pvalue箱线图所在的位置
           col=fpColors(box="#D55E00", lines="#CC79A7", zero = "gray50"),
           # col=fpColors(box=c("royalblue", "gold"),
           #              line=c("darkblue", "orange"),
           #              summary=c("darkblue", "red")),
           mean=c(NA,NA,read$Hazard_Ratio),
           lower=c(NA,NA,read$HR.confint.lower), #95%置信区间下限
           upper=c(NA,NA,read$HR.confint.upper), #95%置信区间上限
           boxsize=0.4,lwd.ci=2,   #箱子大小，线的宽度
           ci.vertices.height = 0.2,ci.vertices=TRUE, #置信区间用线宽、高、型
           zero=1,lwd.zero=1,      #zero线宽 基准线的位置
           colgap=unit(5,"mm"),    #列间隙
           xlog = T,
           #xticks = c(0, 1,22), #横坐标刻度
           lwd.xaxis=2,            #X轴线宽
           lineheight = unit(0.8,"cm"), #固定行高
           graphwidth = unit(.3,"npc"), #图在表中的宽度比例
           cex=0.9, fn.ci_norm = fpDrawCircleCI, #误差条显示方式
           hrzl_lines=list("2" = gpar(lwd=2, col="blue"),
                           "3" = gpar(lwd=2, col="blue"), #第三行顶部加黑线，引号内数字标记行位置
                           "20" = gpar(lwd=2, col="blue")
           ),#最后一行底部加黑线,"34"中数字为nrow(tabletext)+1
           #mar=unit(rep(0.5, times = 4), "cm"),#图形页边距
           #fpTxtGp函数中的cex参数设置各个组件的大小
           txt_gp=fpTxtGp(label=gpar(cex=1.5),
                          ticks=gpar(cex=1.5),
                          xlab=gpar(cex = 1.25),
                          title=gpar(cex = 1.2)),
           #xlab="Hazard Ratio",
)
```

#### STAD森林图

```R
stad <- read.csv('fanai/T_N_jieguo/stad_dan_cox.csv',stringsAsFactors = F,row.names = 1)
hz <- paste(round(stad$Hazard_Ratio,3),
            " (",round(stad$HR.confint.lower,3),
            "-",round(stad$HR.confint.upper,3),")",sep = "")
tabletext <- cbind(c(NA,"Gene",stad$gene_name),
                   c(NA,"Hazard Ratio(95% CI)",hz))

nrow(tabletext)+1
library(forestplot)
forestplot(labeltext=tabletext,
           graph.pos=3,  #为Pvalue箱线图所在的位置
           col=fpColors(box="#D55E00", lines="#CC79A7", zero = "gray50"),
           # col=fpColors(box=c("royalblue", "gold"),
           #              line=c("darkblue", "orange"),
           #              summary=c("darkblue", "red")),
           mean=c(NA,NA,stad$Hazard_Ratio),
           lower=c(NA,NA,stad$HR.confint.lower), #95%置信区间下限
           upper=c(NA,NA,stad$HR.confint.upper), #95%置信区间上限
           boxsize=0.4,lwd.ci=2,   #箱子大小，线的宽度
           ci.vertices.height = 0.2,ci.vertices=TRUE, #置信区间用线宽、高、型
           zero=1,lwd.zero=1,      #zero线宽 基准线的位置
           colgap=unit(5,"mm"),    #列间隙
           xticks = c(0, 1,3.5), #横坐标刻度
           lwd.xaxis=2,            #X轴线宽
           lineheight = unit(0.6,"cm"), #固定行高
           graphwidth = unit(.3,"npc"), #图在表中的宽度比例
           cex=0.9, fn.ci_norm = fpDrawCircleCI, #误差条显示方式
           hrzl_lines=list("2" = gpar(lwd=2, col="blue"),
                           "3" = gpar(lwd=2, col="blue"), #第三行顶部加黑线，引号内数字标记行位置
                           "33" = gpar(lwd=2, col="blue")
                           ),#最后一行底部加黑线,"34"中数字为nrow(tabletext)+1
           #mar=unit(rep(0.5, times = 4), "cm"),#图形页边距
           #fpTxtGp函数中的cex参数设置各个组件的大小
           txt_gp=fpTxtGp(label=gpar(cex=1.5),
                          ticks=gpar(cex=1.5),
                          xlab=gpar(cex = 1.25),
                          title=gpar(cex = 1.2)),
           #xlab="Hazard Ratio",
           )
```

#### 一种肿瘤与其他肿瘤的肿瘤样本的差异分析

```R
#coad
coad_expr <- fread('fanai/COAD/TCGA-COAD.htseq_counts.tsv')
coad_expr <- column_to_rownames(coad_expr,'Ensembl_ID')
#esca
esca_expr <- fread('fanai/ESCA/TCGA-ESCA.htseq_counts.tsv')
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
#stad
stad_expr <- fread('fanai/STAD/TCGA-STAD.htseq_counts.tsv')
stad_expr <- column_to_rownames(stad_expr,'Ensembl_ID')
#read
read_expr <- fread('fanai/READ/TCGA-READ.htseq_counts.tsv')
read_expr <- column_to_rownames(read_expr,'Ensembl_ID')

idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
#coad
coadgene <- data.frame(id = rownames(coad_expr), stringsAsFactors = F)
coadgene <- left_join(coadgene, idmapping, by = "id")
coadgene <- na.omit(coadgene)
coadgene <- coadgene[!duplicated(coadgene$gene),]
coad_expr <- coad_expr[coadgene$id,]
rownames(coad_expr) <- coadgene$gene
#esca
escagene <- data.frame(id = rownames(esca_expr), stringsAsFactors = F)
escagene <- left_join(escagene, idmapping, by = "id")
escagene <- na.omit(escagene)
escagene <- escagene[!duplicated(escagene$gene),]
esca_expr <- esca_expr[escagene$id,]
rownames(esca_expr) <- escagene$gene
#stad
stadgene <- data.frame(id = rownames(stad_expr), stringsAsFactors = F)
stadgene <- left_join(stadgene, idmapping, by = "id")
stadgene <- na.omit(stadgene)
stadgene <- stadgene[!duplicated(stadgene$gene),]
stad_expr <- stad_expr[stadgene$id,]
rownames(stad_expr) <- stadgene$gene
#read
readgene <- data.frame(id = rownames(read_expr), stringsAsFactors = F)
readgene <- left_join(readgene, idmapping, by = "id")
readgene <- na.omit(readgene)
readgene <- readgene[!duplicated(readgene$gene),]
read_expr <- read_expr[readgene$id,]
rownames(read_expr) <- readgene$gene
#coad
coadtum <- c()
coadnor <- c()
for(i in colnames(coad_expr)){
  if(str_sub(i,14,16) == '01A'){
    coadtum <- c(coadtum,i)
  }
  if(str_sub(i,14,16) == '11A'){
    coadnor <- c(coadnor,i)
  }
}
coadtumor <- coad_expr[,coadtum]#肿瘤样本
coadnormal <- coad_expr[,coadnor]#正常样本
coadpairtum <- c()
coadpairnor <- c()
for(i in coadtum){
  tmp1 <- substr(i,1,12)
  coadpairtum <- c(coadpairtum,tmp1)
}
for(i in coadnor){
  tmp1 <- substr(i,1,12)
  coadpairnor <- c(coadpairnor,tmp1)
}
coadpair <- intersect(coadpairtum,coadpairnor)
coadpairtum1 <- c()
coadpairnor1 <- c()
for(i in coadpair){
  coadpairtum1 <- c(coadpairtum1,paste(i,'-01A',sep=''))
}
for(i in coadpair){
  coadpairnor1 <- c(coadpairnor1,paste(i,'-11A',sep=''))
}
coadpairtumor <- coad_expr[,coadpairtum1]#配对的肿瘤样本
coadpairnormal <- coad_expr[,coadpairnor1]#配对的正常样本
#esca
escatum <- c()
escanor <- c()
for(i in colnames(esca_expr)){
  if(str_sub(i,14,16) == '01A'){
    escatum <- c(escatum,i)
  }
  if(str_sub(i,14,16) == '11A'){
    escanor <- c(escanor,i)
  }
}
escatumor <- esca_expr[,escatum]#肿瘤样本
escanormal <- esca_expr[,escanor]#正常样本
escapairtum <- c()
escapairnor <- c()
for(i in escatum){
  tmp1 <- substr(i,1,12)
  escapairtum <- c(escapairtum,tmp1)
}
for(i in escanor){
  tmp1 <- substr(i,1,12)
  escapairnor <- c(escapairnor,tmp1)
}
escapair <- intersect(escapairtum,escapairnor)
escapairtum1 <- c()
escapairnor1 <- c()
for(i in escapair){
  escapairtum1 <- c(escapairtum1,paste(i,'-01A',sep=''))
}
for(i in escapair){
  escapairnor1 <- c(escapairnor1,paste(i,'-11A',sep=''))
}
escapairtumor <- esca_expr[,escapairtum1]#配对的肿瘤样本
escapairnormal <- esca_expr[,escapairnor1]#配对的正常样本
#stad
stadtum <- c()
stadnor <- c()
for(i in colnames(stad_expr)){
  if(str_sub(i,14,16) == '01A'){
    stadtum <- c(stadtum,i)
  }
  if(str_sub(i,14,16) == '11A'){
    stadnor <- c(stadnor,i)
  }
}
stadtumor <- stad_expr[,stadtum]#肿瘤样本
stadnormal <- stad_expr[,stadnor]#正常样本
stadpairtum <- c()
stadpairnor <- c()
for(i in stadtum){
  tmp1 <- substr(i,1,12)
  stadpairtum <- c(stadpairtum,tmp1)
}
for(i in stadnor){
  tmp1 <- substr(i,1,12)
  stadpairnor <- c(stadpairnor,tmp1)
}
stadpair <- intersect(stadpairtum,stadpairnor)
stadpairtum1 <- c()
stadpairnor1 <- c()
for(i in stadpair){
  stadpairtum1 <- c(stadpairtum1,paste(i,'-01A',sep=''))
}
for(i in stadpair){
  stadpairnor1 <- c(stadpairnor1,paste(i,'-11A',sep=''))
}
stadpairtumor <- stad_expr[,stadpairtum1]#配对的肿瘤样本
stadpairnormal <- stad_expr[,stadpairnor1]#配对的正常样本
#read
readtum <- c()
readnor <- c()
for(i in colnames(read_expr)){
  if(str_sub(i,14,16) == '01A'){
    readtum <- c(readtum,i)
  }
  if(str_sub(i,14,16) == '11A'){
    readnor <- c(readnor,i)
  }
}
readtumor <- read_expr[,readtum]#肿瘤样本
readnormal <- read_expr[,readnor]#正常样本
readpairtum <- c()
readpairnor <- c()
for(i in readtum){
  tmp1 <- substr(i,1,12)
  readpairtum <- c(readpairtum,tmp1)
}
for(i in readnor){
  tmp1 <- substr(i,1,12)
  readpairnor <- c(readpairnor,tmp1)
}
readpair <- intersect(readpairtum,readpairnor)
readpairtum1 <- c()
readpairnor1 <- c()
for(i in readpair){
  readpairtum1 <- c(readpairtum1,paste(i,'-01A',sep=''))
}
for(i in readpair){
  readpairnor1 <- c(readpairnor1,paste(i,'-11A',sep=''))
}
readpairtumor <- read_expr[,readpairtum1]#配对的肿瘤样本
readpairnormal <- read_expr[,readpairnor1]#配对的正常样本

er <- cbind(escatumor,readtumor)
ers <- cbind(er,stadtumor)
c_ers <- cbind(coadtumor,ers)
c_ers <- 2^c_ers-1
c_ers <- round(c_ers)
library(DESeq2)
condition <- factor(c(rep("coad",length(colnames(coadtumor))),rep("qita",length(ers))), levels = c("coad","qita"))
colData <- data.frame(row.names=colnames(c_ers), condition)
dds <- DESeqDataSetFromMatrix(c_ers, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "coad", "qita"))
res_coad = res[order(res$pvalue),]
diff_cers <- subset(res_coad,padj < 0.05 & abs(log2FoldChange) > 1.5)
write.csv(diff_cers,file="fanai/T_N_jieguo/chayi_coad_T_N.csv")
save("chayijiyin_cers.RData")
```

