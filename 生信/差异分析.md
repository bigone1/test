### DESeq2

```R
load("gdc.Rdata")
library(DESeq2)
colData <- data.frame(row.names =colnames(expr), 
                      condition=group_list)
dds <- DESeqDataSetFromMatrix(
  countData = expr,
  colData = colData,
  design = ~ condition)
dds <- DESeq(dds)
res <- results(dds, contrast = c("condition",rev(levels(group_list))))
resOrdered <- res[order(res$pvalue),]
DEG_DESeq2 <- as.data.frame(resOrdered)
DEG_DESeq2 <- na.omit(DEG_DESeq2)
#计算logFC阈值
logFC_cutoff <- with(DEG_DESeq2,mean(abs(log2FoldChange)) + 
                       2*sd(abs(log2FoldChange)))
#直接设置logFC阈值
logFC_cutoff <- 2
DEG_DESeq2$change = as.factor(
  ifelse(DEG_DESeq2$padj < 0.05 & abs(DEG_DESeq2$log2FoldChange) > logFC_cutoff,
         ifelse(DEG_DESeq2$log2FoldChange > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_DESeq2 <- subset(DEG_DESeq2,padj<0.05 & abs(log2FoldChange)>2)
```

### edgeR

```R
library(edgeR)

dge <- DGEList(counts=expr,group=group_list)
dge$samples$lib.size <- colSums(dge$counts)
dge <- calcNormFactors(dge) 

design <- model.matrix(~0+group_list)
rownames(design)<-colnames(dge)
colnames(design)<-levels(group_list)

dge <- estimateGLMCommonDisp(dge,design)
dge <- estimateGLMTrendedDisp(dge, design)
dge <- estimateGLMTagwiseDisp(dge, design)

fit <- glmFit(dge, design)
fit2 <- glmLRT(fit, contrast=c(-1,1)) 

DEG_edgeR <- topTags(fit2, n=nrow(expr))
DEG_edgeR=as.data.frame(DEG_edgeR)
logFC_cutoff <- with(DEG_edgeR,mean(abs(logFC)) + 2*sd(abs(logFC)) )
#logFC_cutoff <- 2
DEG_edgeR$change = as.factor(
  ifelse(DEG_edgeR$FDR < 0.05 & abs(DEG_edgeR$logFC) > logFC_cutoff,
         ifelse(DEG_edgeR$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_edgeR <- subset(DEG_edgeR,FDR<0.05 & abs(logFC)>2)
```

### limma---1

```R
library(limma)

design <- model.matrix(~0+group_list)
colnames(design)=levels(group_list)
rownames(design)=colnames(expr)

dge <- DGEList(counts=expr)
dge <- calcNormFactors(dge)
logCPM <- cpm(dge, log=TRUE, prior.count=3)

v <- voom(dge,design, normalize="quantile")
fit <- lmFit(v, design)

constrasts = paste(rev(levels(group_list)),collapse = "-")
cont.matrix <- makeContrasts(contrasts=constrasts,levels = design) 
fit2=contrasts.fit(fit,cont.matrix)
fit2=eBayes(fit2)

DEG_limma = topTable(fit2, coef=constrasts, n=Inf)
DEG_limma = na.omit(DEG_limma)
#logFC_cutoff <- with(DEG_limma,mean(abs(logFC)) + 2*sd(abs(logFC)) )
logFC_cutoff <- 2
DEG_limma$change = as.factor(
  ifelse(DEG_limma$adj.P.Val < 0.05 & abs(DEG_limma$logFC) > logFC_cutoff,
         ifelse(DEG_limma$logFC > logFC_cutoff ,'UP','DOWN'),'NOT')
)
diff_limma <- subset(DEG_limma,adj.P.Val<0.05 & abs(logFC)>2)
```

### limma---2

```R
library(limma)
expr.df <- read.table(file = "GSE42872_series_matrix.txt.gz", header =TRUE,
                      comment.char = "!")
library(hugene10sttranscriptcluster.db)
k <- as.character(expr.df$ID_REF)
out <- select(hugene10sttranscriptcluster.db,keys=k,
              columns=c('SYMBOL','GENENAME'),keytype='PROBEID')
out <- na.omit(out)
expr.df$symbol <- out[match(expr.df$ID_REF,out$PROBEID),2]
expr.df <- na.omit(expr.df)
expr.df <- dplyr::filter(expr.df,!duplicated(expr.df$symbol))
rownames(expr.df) <- expr.df$symbol
expr.df <- expr.df[,-ncol(expr.df)]
expr.df <- expr.df[,-1]
group <- c(rep("con",3),rep("treat",3))
group <- factor(group,levels = c("con","treat"),ordered = F)
design <- model.matrix(~group)
colnames(design) <- levels(group)
fit <- lmFit(expr.df,design)
fit2 <- eBayes(fit)
allDiff=topTable(fit2,adjust='fdr',coef=2,number=Inf)
diffLab <- subset(allDiff,abs(logFC) >1 & adj.P.Val < 0.05)
```

### GDCRNATools--R包：an R/Bioconductor package for downloading, organizing, and integrative analyzing lncRNA, mRNA, and miRNA data in GDC

https://github.com/Jialab-UCR/GDCRNATools

```R
library(GDCRNATools)
#mRNA的表达矩阵
data(rnaCounts)
#临床信息
metaMatrix.RNA <- gdcParseMetadata(project.id = 'TCGA-CHOL',
                                   data.type  = 'RNAseq',
                                   write.meta = FALSE)
metaMatrix.RNA <- gdcFilterDuplicate(metaMatrix.RNA)
metaMatrix.RNA <- gdcFilterSampleType(metaMatrix.RNA)
#过滤
rnaExpr <- gdcVoomNormalization(counts = rnaCounts, filter = FALSE)
#差异分析
DEGAll <- gdcDEAnalysis(counts     = rnaCounts, 
                        group      = metaMatrix.RNA$sample_type, 
                        comparison = 'PrimaryTumor-SolidTissueNormal', 
                        method     = 'limma')
dePC <- gdcDEReport(deg = DEGAll, gene.type = 'protein_coding')
#两个基因的相关性图
gdcCorPlot(gene1    = 'ENSG00000003989', 
           gene2    = 'ENSG00000004799', 
           rna.expr = rnaExpr, 
           metadata = metaMatrix.RNA)
#生存分析：两种方法---coxph、KM
survOutput1 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'coxph', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA)
survOutput2 <- gdcSurvivalAnalysis(gene     = rownames(dePC), 
                                  method   = 'KM', 
                                  rna.expr = rnaExpr, 
                                  metadata = metaMatrix.RNA, 
                                  sep      = 'median')
gdcKMPlot(gene     = 'ENSG00000003989',
          rna.expr = rnaExpr,
          metadata = metaMatrix.RNA,
          sep      = 'median')
```

```R
library(data.table)
esca_expr <- fread('fanai/TCGA-ESCA.htseq_counts.tsv')
library(tibble)
esca_expr <- column_to_rownames(esca_expr,'Ensembl_ID')
esca_expr_lie <- colnames(esca_expr)
#提取肿瘤样本表达数据
library(stringr)
group_list = ifelse(as.numeric(str_sub(esca_expr_lie,14,15))<10,"Tumor","Normal")
fenzu <- data.frame(sample=esca_expr_lie,group=group_list)
tumor <- esca_expr[group_list=='Tumor']
library(dplyr)
idmapping <- fread("fanai/gencode.v22.annotation.gene.probeMap")
geneid <- data.frame(id = rownames(tumor), stringsAsFactors = F)
geneid2symbol <- left_join(geneid, idmapping, by = "id")
geneid2symbol <- na.omit(geneid2symbol)
geneid2symbol <- geneid2symbol[!duplicated(geneid2symbol$gene),]
tumor <- tumor[geneid2symbol$id,]
rownames(tumor) <- geneid2symbol$gene
write.table(tumor,file='fanai/esca_tumor.txt',sep='\t')
#计算免疫基质评分
library(estimate)
OvarianCancerExpr <- system.file('extdata','esca_tumor.txt',package = 'estimate')
filterCommonGenes(input.f = OvarianCancerExpr,output.f = 'genes.gct',id='GeneSymbol')
estimateScore(input.ds = 'genes.gct',output.ds = 'score.gct',platform = 'illumina')#参数platform，默认为'affymetrix',还有'illumina','agilent'
scores=read.table("score.gct",skip = 2,header = T)
rownames(scores)=scores[,1]
scores=t(scores[,3:ncol(scores)])
write.csv(scores,file = 'fanai/ESCA/esca_scores.csv')
#根据免疫评分分组做差异分析
mianyi_z <- rownames(scores[scores[,2]>=0,])
mianyi_f <- rownames(scores[scores[,2]<0,])
mianyi_z <- gsub('[.]','-',mianyi_z)
mianyi_f <- gsub('[.]','-',mianyi_f)
mianyi_z_expr <- tumor[,mianyi_z]
mianyi_z_expr <- 2^mianyi_z_expr-1
mianyi_z_expr <- round(mianyi_z_expr)
mianyi_f_expr <- tumor[,mianyi_f]
mianyi_f_expr <- 2^mianyi_f_expr-1
mianyi_f_expr <- round(mianyi_f_expr)
mianyi_expr <- cbind(mianyi_z_expr,mianyi_f_expr)
keep <- rowSums(mianyi_expr) >= 10
mianyi_expr <- mianyi_expr[keep,]
#编码基因
tmp <- load('fanai/anno.rda')
#筛选编码基因的表达矩阵
bianma <- intersect(mRNA_anno$gene_name,rownames(mianyi_expr))
mianyi_expr <- mianyi_expr[bianma,]
library(DESeq2)
condition <- factor(c(rep("high",length(mianyi_z)),rep("low",length(mianyi_f))), levels = c("high","low"))
colData <- data.frame(row.names=colnames(mianyi_expr), condition)
dds <- DESeqDataSetFromMatrix(mianyi_expr, colData, design= ~ condition)
dds <- DESeq(dds)
res = results(dds, contrast=c("condition", "high", "low"),alpha = 0.05)
res_esca = res[order(res$padj),]
diff_esca <- subset(res_esca,padj<0.05 & abs(log2FoldChange)>1.5)
rld <- vst(dds,blind = T)
expr_norm <- assay(rld)
DESeq_norm_for_survial <- expr_norm[diff_esca@rownames,]
clinical <- fread('fanai/TCGA-ESCA.survival.tsv')
survival_cancer <- clinical
data <- t(DESeq_norm_for_survial)
survival_cancer <- column_to_rownames(survival_cancer,'sample')
jiaoji <- intersect(rownames(data),rownames(survival_cancer))
data <- data[jiaoji,]
survival_cancer <- survival_cancer[jiaoji,]
survival_cancer <- cbind(survival_cancer,data)
colnames(survival_cancer) <- gsub(colnames(survival_cancer),pattern = '-',replacement = '_')
uni_cox_bulk <- function(gene_list,survival_info_df){
  library(survival)
  gene_list <- gsub(gene_list,pattern = '-',replacement = '_')
  uni_cox <- function(single_gene){
    formula <- as.formula(paste0('Surv(OS.time,OS)~',single_gene))
    surv_uni_cox <- summary(coxph(formula,data=survival_cancer))
    ph_hypothesis_p <- cox.zph(coxph(formula,data=survival_cancer))$table[1,3]
    if(surv_uni_cox$coefficients[,5] < 0.05 & ph_hypothesis_p > 0.05){
      single_cox_report <- data.frame('gene_name'=single_gene,
                                      'beta'=surv_uni_cox$coefficients[,1],
                                      'Hazard_Ratio'=exp(surv_uni_cox$coefficients[,1]),
                                      'z_pvalue'=surv_uni_cox$coefficients[,5],
                                      'Wald_pvalue'=as.numeric(surv_uni_cox$waldtest[3]),
                                      'Likelihood_pvalue'=as.numeric(surv_uni_cox$logtest[3]))
      single_cox_report                                
    }
  }
  uni_cox_list <- lapply(gene_list,uni_cox)
  do.call(rbind,uni_cox_list)
}
uni_cox_df <- uni_cox_bulk(gene_list = diff_esca@rownames,survival_info_df = survival_cancer)
write.csv(diff_esca,file="fanai/ESCA/chayi_esca2.csv")
```

